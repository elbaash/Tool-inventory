<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Tool Inventory Manager</title>
    <meta name="description" content="AI-powered tool inventory with photo identification and voice batch entry">
    
    <!-- React and dependencies -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiQUkgVG9vbCBJbnZlbnRvcnkgTWFuYWdlciIsInNob3J0X25hbWUiOiJBSSBJbnZlbnRvcnkiLCJ0aGVtZV9jb2xvciI6IiMyNTYzZWIiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiI2Y5ZmFmYiIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwic3RhcnRfdXJsIjoiLyIsImljb25zIjpbeyJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUIzYVdSMGFEMGlNalFpSUdobGFXZG9kRDBpTWpRaUlIWnBaWGRDYjNnOUlqQWdNQ0F5TkNBeU5DSWdabWxzYkQwaUl6STFOak5sWWlJK1BISmxZM1FnZUQwaU5DSWdlVDBpTkNJZ2QybGtkR2c5SWpFMklpQm9aV2xuYUhROUlqRTJJaUJtYVd4c1BTSjBjbUZ1YzJoaFpXNTBJajQ4TDNKbFkzUStQQzl6ZG1jKyIsInNpemVzIjoiMjR4MjQiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9XX0=">
    
    <!-- Mobile optimizations -->
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="AI Tool Inventory">
    
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; font-family: system-ui, -apple-system, sans-serif; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // Icons as SVG components
        const SearchIcon = () => (
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
            </svg>
        );
        
        const PlusIcon = () => (
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M12 5v14M5 12h14"/>
            </svg>
        );
        
        const BoxIcon = () => (
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
            </svg>
        );
        
        const SettingsIcon = () => (
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6M1 12h6m6 0h6"/>
            </svg>
        );
        
        const CameraIcon = () => (
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/>
            </svg>
        );
        
        const MicIcon = () => (
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2M12 19v4M8 23h8"/>
            </svg>
        );
        
        const EditIcon = () => (
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
            </svg>
        );
        
        const TrashIcon = () => (
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
            </svg>
        );
        
        const CheckIcon = () => (
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M20 6 9 17l-5-5"/>
            </svg>
        );
        
        const AlertIcon = () => (
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10"/><path d="M12 8v4m0 4h.01"/>
            </svg>
        );
        
        const XIcon = () => (
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M18 6 6 18M6 6l12 12"/>
            </svg>
        );

        function InventoryApp() {
            // State management
            const [items, setItems] = useState([]);
            const [searchQuery, setSearchQuery] = useState('');
            const [filteredItems, setFilteredItems] = useState([]);
            const [view, setView] = useState('search'); // search, add, boxes, settings, aiPhoto, aiVoice
            const [isLoading, setIsLoading] = useState(false);
            const [message, setMessage] = useState({ text: '', type: '' });
            const [showSetupGuide, setShowSetupGuide] = useState(true);
            
            // Settings
            const [settings, setSettings] = useState({
                googleSheetsUrl: localStorage.getItem('googleSheetsUrl') || '',
                autoSync: localStorage.getItem('autoSync') === 'true' || false,
                aiEnabled: localStorage.getItem('aiEnabled') === 'true' || false,
                ollamaUrl: localStorage.getItem('ollamaUrl') || 'http://localhost:11434',
                aiServerUrl: localStorage.getItem('aiServerUrl') || 'http://localhost:8000',
            });

            // Add/Edit item state
            const [editingItem, setEditingItem] = useState(null);
            const [formData, setFormData] = useState({
                name: '',
                box: '',
                quantity: '1',
                notes: '',
                photo: null
            });

            // Voice recording
            const [isRecording, setIsRecording] = useState(false);
            const [transcript, setTranscript] = useState('');
            
            // AI Photo
            const [capturedImage, setCapturedImage] = useState(null);
            const [aiIdentification, setAiIdentification] = useState(null);
            const videoRef = useRef(null);
            const canvasRef = useRef(null);

            // NEW: Enhanced sync features - OPTIMIZED with useReducer
            const syncReducer = (state, action) => {
                switch (action.type) {
                    case 'SET_CONNECTION_STATUS':
                        return { ...state, connectionStatus: action.payload };
                    case 'SET_LAST_SYNC':
                        return {
                            ...state,
                            lastSyncTime: action.payload.time,
                            lastSyncStatus: action.payload.status
                        };
                    case 'ADD_HISTORY':
                        return {
                            ...state,
                            syncHistory: [action.payload, ...state.syncHistory].slice(0, 20)
                        };
                    case 'SET_TEST_RESULTS':
                        return { ...state, testResults: action.payload };
                    case 'TOGGLE_LOGS':
                        return { ...state, showLogs: !state.showLogs };
                    case 'SET_SHOW_LOGS':
                        return { ...state, showLogs: action.payload };
                    case 'SET_SYNC_DIFF':
                        return {
                            ...state,
                            showSyncDiff: action.payload.show,
                            syncDiffData: action.payload.data
                        };
                    case 'CLOSE_SYNC_DIFF':
                        return { ...state, showSyncDiff: false, syncDiffData: null };
                    default:
                        return state;
                }
            };

            const [syncState, dispatchSync] = useReducer(syncReducer, {
                connectionStatus: 'unknown',
                lastSyncTime: null,
                lastSyncStatus: null,
                syncHistory: [],
                testResults: null,
                showLogs: false,
                showSyncDiff: false,
                syncDiffData: null
            });

            // Setup progress persisted to localStorage
            const [setupProgress, setSetupProgress] = useState(() => {
                try {
                    const saved = localStorage.getItem('setupProgress');
                    return saved ? JSON.parse(saved) : {
                        step1: false,
                        step2: false,
                        step3: false,
                        step4: false,
                        step5: false
                    };
                } catch (e) {
                    return { step1: false, step2: false, step3: false, step4: false, step5: false };
                }
            });

            // Update setup progress with persistence
            const updateSetupProgress = (step, value) => {
                const newProgress = { ...setupProgress, [step]: value };
                setSetupProgress(newProgress);
                try {
                    localStorage.setItem('setupProgress', JSON.stringify(newProgress));
                } catch (e) {
                    console.error('Failed to save setup progress:', e);
                }
            };

            // Sync logs stored in localStorage, loaded only when needed
            const [syncLogs, setSyncLogs] = useState([]);

            // Request deduplication
            const syncInProgress = useRef(false);
            const abortControllers = useRef(new Set());

            // ============================================
            // UTILITY FUNCTIONS - Enhanced Error Handling
            // ============================================

            // Log helper function - OPTIMIZED to use localStorage
            const addLog = useCallback((level, message, details = null) => {
                const logEntry = {
                    timestamp: new Date().toISOString(),
                    level,
                    message,
                    details
                };

                // Console log with appropriate method
                const logMethod = level === 'error' ? console.error : level === 'warning' ? console.warn : console.log;
                logMethod(`[${level.toUpperCase()}] ${message}`, details || '');

                try {
                    // Store in localStorage, not React state (prevents memory leaks)
                    const logs = JSON.parse(localStorage.getItem('syncLogs') || '[]');
                    logs.unshift(logEntry);
                    const trimmedLogs = logs.slice(0, 100); // Keep last 100
                    localStorage.setItem('syncLogs', JSON.stringify(trimmedLogs));

                    // Only update state if logs modal is open (performance optimization)
                    if (syncState.showLogs) {
                        setSyncLogs(trimmedLogs);
                    }
                } catch (e) {
                    console.error('Failed to save log:', e);
                }
            }, [syncState.showLogs]);

            // Load logs from localStorage when modal opens
            const loadLogs = useCallback(() => {
                try {
                    const logs = JSON.parse(localStorage.getItem('syncLogs') || '[]');
                    setSyncLogs(logs);
                } catch (e) {
                    console.error('Failed to load logs:', e);
                    setSyncLogs([]);
                }
            }, []);

            // URL Validation
            const validateGoogleSheetsUrl = (url) => {
                if (!url || url.trim() === '') {
                    return { valid: false, error: 'URL is empty. Please enter your Google Apps Script URL.' };
                }

                // Must be HTTPS
                if (!url.startsWith('https://')) {
                    return { valid: false, error: 'URL must start with https:// for security.' };
                }

                // Must be Google Apps Script URL
                if (!url.includes('script.google.com/macros/')) {
                    return {
                        valid: false,
                        error: 'This doesn\'t look like a Google Apps Script URL. It should contain "script.google.com/macros/"'
                    };
                }

                // Should end with /exec (deployed) not /dev (test mode)
                if (url.includes('/dev')) {
                    return {
                        valid: false,
                        error: 'âš ï¸ This is a DEVELOPMENT URL. You must deploy the script properly!\n\nGo to Apps Script â†’ Deploy â†’ New deployment â†’ Set as "Web app"'
                    };
                }

                if (!url.endsWith('/exec')) {
                    return {
                        valid: false,
                        error: 'URL should end with /exec. Make sure you copied the complete deployment URL.'
                    };
                }

                return { valid: true };
            };

            // Error Type Detection
            const detectErrorType = (error, response) => {
                // Network error (no response at all)
                if (!response && error.message === 'Failed to fetch') {
                    return {
                        type: 'NETWORK',
                        title: 'ðŸŒ Network Error',
                        message: 'Cannot reach Google Sheets',
                        help: 'â€¢ Check your internet connection\nâ€¢ Check if firewall is blocking the request\nâ€¢ Try opening the URL in a new browser tab',
                        severity: 'error'
                    };
                }

                // Timeout
                if (error.message && error.message.includes('timeout')) {
                    return {
                        type: 'TIMEOUT',
                        title: 'â±ï¸ Request Timeout',
                        message: 'Google Sheets took too long to respond',
                        help: 'â€¢ Your spreadsheet might be very large\nâ€¢ Try again in a few moments\nâ€¢ Check your internet speed',
                        severity: 'warning'
                    };
                }

                // CORS error (typical with wrong deployment)
                if (!response || (error.message && error.message.toLowerCase().includes('cors'))) {
                    return {
                        type: 'CORS',
                        title: 'ðŸš« Access Blocked (CORS)',
                        message: 'Deployment configuration issue detected',
                        help: 'ðŸ“‹ FIX THIS:\n1. Go to your Google Apps Script\n2. Click "Deploy" â†’ "Manage deployments"\n3. Click the pencil icon (âš™ï¸ Edit)\n4. Set "Who has access" to "Anyone"\n5. Click "Deploy"\n6. Copy the NEW URL and update settings',
                        severity: 'error'
                    };
                }

                // HTTP errors
                if (response) {
                    if (response.status === 401 || response.status === 403) {
                        return {
                            type: 'AUTH',
                            title: 'ðŸ” Authorization Failed',
                            message: `Access denied (HTTP ${response.status})`,
                            help: 'â€¢ Click your Google Apps Script URL in a browser\nâ€¢ Make sure you authorize the app\nâ€¢ Ensure "Execute as: Me" is selected in deployment\nâ€¢ Try re-deploying the script',
                            severity: 'error'
                        };
                    }
                    if (response.status === 404) {
                        return {
                            type: 'NOT_FOUND',
                            title: 'â“ Script Not Found',
                            message: 'Could not find the Google Apps Script',
                            help: 'â€¢ Double-check you copied the COMPLETE URL\nâ€¢ Make sure the script is actually deployed\nâ€¢ Try deploying again and get a new URL',
                            severity: 'error'
                        };
                    }
                    if (response.status === 500 || response.status === 502) {
                        return {
                            type: 'SERVER',
                            title: 'âš™ï¸ Google Script Error',
                            message: 'Error in your Google Apps Script code',
                            help: 'â€¢ Open Apps Script editor\nâ€¢ Check "Executions" log for errors\nâ€¢ Make sure you copied the COMPLETE script code\nâ€¢ Verify your spreadsheet has the correct columns',
                            severity: 'error'
                        };
                    }
                }

                return {
                    type: 'UNKNOWN',
                    title: 'âŒ Sync Failed',
                    message: error.message || 'Unknown error occurred',
                    help: 'â€¢ Check the logs for more details\nâ€¢ Try testing the connection first\nâ€¢ Contact support if issue persists',
                    severity: 'error'
                };
            };

            // Fetch with timeout
            const fetchWithTimeout = async (url, options, timeout = 30000) => {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), timeout);

                try {
                    const response = await fetch(url, {
                        ...options,
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);
                    return response;
                } catch (error) {
                    clearTimeout(timeoutId);
                    if (error.name === 'AbortError') {
                        throw new Error('Request timeout - Google Sheets took too long to respond (>30s)');
                    }
                    throw error;
                }
            };

            // Check if error is retriable (only network errors and 5xx)
            const isRetriable = (error, response) => {
                // Network errors (no response) - should retry
                if (!response) return true;

                // Only retry server errors (5xx)
                // Don't retry client errors (4xx) - they won't fix themselves
                return response.status >= 500;
            };

            // Fetch with SMART retry logic - FIXED
            const fetchWithRetry = async (url, options, retries = 3) => {
                let lastResponse = null;

                for (let i = 0; i < retries; i++) {
                    try {
                        addLog('info', `Attempt ${i + 1}/${retries} to reach Google Sheets...`);
                        const response = await fetchWithTimeout(url, options);
                        lastResponse = response;
                        return response;
                    } catch (error) {
                        // Check if we should retry this error
                        if (i === retries - 1 || !isRetriable(error, lastResponse)) {
                            // Don't retry 4xx errors or if this is the last attempt
                            if (lastResponse && lastResponse.status >= 400 && lastResponse.status < 500) {
                                addLog('error', `Client error (${lastResponse.status}) - not retrying`, error.message);
                            }
                            throw error;
                        }

                        const waitTime = 1000 * Math.pow(2, i); // 1s, 2s, 4s
                        addLog('warning', `Attempt ${i + 1} failed, retrying in ${waitTime/1000}s...`, error.message);
                        await new Promise(resolve => setTimeout(resolve, waitTime));
                    }
                }
            };

            // Response validation
            const validateResponse = async (response) => {
                // Check HTTP status first
                if (!response.ok) {
                    const errorText = await response.text();
                    addLog('error', `HTTP Error ${response.status}`, errorText.substring(0, 200));
                    throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 100)}`);
                }

                // Check content type
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    addLog('error', 'Invalid response format (expected JSON)', text.substring(0, 200));
                    throw new Error(`Expected JSON but got: ${contentType}. Response: ${text.substring(0, 100)}`);
                }

                // Parse JSON safely
                try {
                    const data = await response.json();
                    addLog('success', 'Response received and parsed successfully', data);
                    return data;
                } catch (error) {
                    addLog('error', 'JSON parsing failed', error.message);
                    throw new Error('Invalid JSON response from Google Sheets: ' + error.message);
                }
            };

            // Browser compatibility check
            const checkBrowserCompatibility = () => {
                const issues = [];

                if (typeof fetch === 'undefined') {
                    issues.push('fetch API not supported');
                }
                if (typeof localStorage === 'undefined') {
                    issues.push('localStorage not supported');
                }
                if (typeof Promise === 'undefined') {
                    issues.push('Promises not supported');
                }

                return {
                    compatible: issues.length === 0,
                    issues
                };
            };

            // Calculate sync diff
            const calculateSyncDiff = (localItems, remoteItems) => {
                const localMap = new Map(localItems.map(item => [item.id, item]));
                const remoteMap = new Map(remoteItems.map(item => [item.id, item]));

                const onlyLocal = localItems.filter(item => !remoteMap.has(item.id));
                const onlyRemote = remoteItems.filter(item => !localMap.has(item.id));
                const modified = [];

                localItems.forEach(localItem => {
                    const remoteItem = remoteMap.get(localItem.id);
                    if (remoteItem) {
                        if (JSON.stringify(localItem) !== JSON.stringify(remoteItem)) {
                            modified.push({ local: localItem, remote: remoteItem });
                        }
                    }
                });

                return {
                    onlyLocal,
                    onlyRemote,
                    modified,
                    hasConflicts: modified.length > 0 || (onlyLocal.length > 0 && onlyRemote.length > 0)
                };
            };

            // Load sample data on first use
            useEffect(() => {
                const storedItems = localStorage.getItem('inventoryItems');
                if (storedItems) {
                    setItems(JSON.parse(storedItems));
                    setShowSetupGuide(false);
                } else {
                    // Sample data
                    const sampleData = [
                        { id: 1, name: 'Hammer', box: '10', quantity: '1', notes: 'Claw hammer' },
                        { id: 2, name: 'Hammerrite Paint', box: '15', quantity: '2', notes: 'Black metal paint' },
                        { id: 3, name: 'Hand Saw', box: '10', quantity: '1', notes: '20 inch' },
                        { id: 4, name: 'Screwdriver Set', box: '10', quantity: '1', notes: 'Phillips and flathead' },
                        { id: 5, name: 'Drill', box: '5', quantity: '1', notes: 'Cordless 20V' },
                        { id: 6, name: 'Level', box: '12', quantity: '1', notes: '2 foot aluminum' },
                    ];
                    setItems(sampleData);
                }
            }, []);

            // Save items to localStorage
            useEffect(() => {
                if (items.length > 0) {
                    localStorage.setItem('inventoryItems', JSON.stringify(items));
                }
            }, [items]);

            // Filter items based on search
            useEffect(() => {
                if (searchQuery.trim() === '') {
                    setFilteredItems([]);
                } else {
                    const query = searchQuery.toLowerCase();
                    const filtered = items.filter(item =>
                        item.name.toLowerCase().includes(query) ||
                        item.box.toLowerCase().includes(query) ||
                        (item.notes && item.notes.toLowerCase().includes(query))
                    );
                    setFilteredItems(filtered);
                }
            }, [searchQuery, items]);

            // Show message helper
            const showMessage = (text, type = 'success') => {
                setMessage({ text, type });
                setTimeout(() => setMessage({ text: '', type: '' }), 3000);
            };

            // Add or update item
            const handleSaveItem = async () => {
                if (!formData.name || !formData.box) {
                    showMessage('Please fill in item name and box number', 'error');
                    return;
                }

                if (editingItem) {
                    // Update existing
                    setItems(items.map(item =>
                        item.id === editingItem.id ? { ...item, ...formData } : item
                    ));
                    showMessage('Item updated!');
                } else {
                    // Add new
                    const newItem = {
                        id: Date.now(),
                        ...formData
                    };
                    setItems([...items, newItem]);
                    showMessage('Item added!');
                }

                // Auto-sync to Google Sheets if enabled
                if (settings.autoSync && settings.googleSheetsUrl) {
                    setTimeout(() => pushToSheets(), 500);
                }

                // Reset form
                setFormData({ name: '', box: '', quantity: '1', notes: '', photo: null });
                setEditingItem(null);
                setView('search');
            };

            // Delete item
            const handleDeleteItem = (id) => {
                if (confirm('Are you sure you want to delete this item?')) {
                    setItems(items.filter(item => item.id !== id));
                    showMessage('Item deleted');

                    // Auto-sync to Google Sheets if enabled
                    if (settings.autoSync && settings.googleSheetsUrl) {
                        setTimeout(() => pushToSheets(), 500);
                    }
                }
            };

            // Start editing
            const handleEditItem = (item) => {
                setEditingItem(item);
                setFormData({
                    name: item.name,
                    box: item.box,
                    quantity: item.quantity,
                    notes: item.notes || '',
                    photo: item.photo || null
                });
                setView('add');
            };

            // Push local items to Google Sheets - ENHANCED VERSION
            const pushToSheets = async () => {
                if (!settings.googleSheetsUrl) {
                    showMessage('Please configure Google Sheets URL in settings', 'error');
                    return false;
                }

                // Validate URL first
                const urlCheck = validateGoogleSheetsUrl(settings.googleSheetsUrl);
                if (!urlCheck.valid) {
                    showMessage(urlCheck.error, 'error');
                    dispatchSync({ type: 'SET_CONNECTION_STATUS', payload: 'error' });
                    return false;
                }

                setIsLoading(true);
                dispatchSync({ type: 'SET_CONNECTION_STATUS', payload: 'unknown' });
                let response = null;

                try {
                    addLog('info', 'ðŸ“¤ Starting PUSH to Google Sheets...');
                    addLog('info', `Items to sync: ${items.length}`);

                    response = await fetchWithRetry(settings.googleSheetsUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'updateAll',
                            items: items
                        })
                    });

                    addLog('info', `Response status: ${response.status}`);

                    const data = await validateResponse(response);

                    if (data.success) {
                        addLog('success', 'âœ… Push successful!', data);
                        dispatchSync({ type: 'SET_CONNECTION_STATUS', payload: 'connected' });
                        dispatchSync({
                            type: 'SET_LAST_SYNC',
                            payload: { time: new Date().toLocaleString(), status: 'success' }
                        });

                        // Add to sync history
                        dispatchSync({
                            type: 'ADD_HISTORY',
                            payload: {
                                timestamp: new Date().toISOString(),
                                direction: 'push',
                                status: 'success',
                                itemCount: items.length
                            }
                        });

                        return true;
                    } else {
                        throw new Error(data.error || 'Unknown error from Google Sheets');
                    }
                } catch (error) {
                    const errorInfo = detectErrorType(error, response);
                    addLog('error', errorInfo.title, errorInfo.message);

                    dispatchSync({ type: 'SET_CONNECTION_STATUS', payload: 'error' });
                    dispatchSync({
                        type: 'SET_LAST_SYNC',
                        payload: { time: new Date().toLocaleString(), status: 'failed' }
                    });

                    // Add to sync history
                    dispatchSync({
                        type: 'ADD_HISTORY',
                        payload: {
                            timestamp: new Date().toISOString(),
                            direction: 'push',
                            status: 'failed',
                            error: errorInfo.message
                        }
                    });

                    showMessage(
                        `${errorInfo.title}\n${errorInfo.message}\n\nðŸ’¡ ${errorInfo.help}`,
                        'error'
                    );
                    return false;
                } finally {
                    setIsLoading(false);
                }
            };

            // Pull items from Google Sheets - ENHANCED VERSION
            const pullFromSheets = async (showDiff = false) => {
                if (!settings.googleSheetsUrl) {
                    showMessage('Please configure Google Sheets URL in settings', 'error');
                    return false;
                }

                // Validate URL first
                const urlCheck = validateGoogleSheetsUrl(settings.googleSheetsUrl);
                if (!urlCheck.valid) {
                    showMessage(urlCheck.error, 'error');
                    dispatchSync({ type: 'SET_CONNECTION_STATUS', payload: 'error' });
                    return false;
                }

                setIsLoading(true);
                setConnectionStatus('unknown');
                let response = null;

                try {
                    addLog('info', 'ðŸ“¥ Starting PULL from Google Sheets...');

                    response = await fetchWithRetry(settings.googleSheetsUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'getAll' })
                    });

                    addLog('info', `Response status: ${response.status}`);

                    const data = await validateResponse(response);

                    // CRITICAL: Validate data structure - FIXED
                    if (!data.items || !Array.isArray(data.items)) {
                        throw new Error('Invalid response: items must be an array');
                    }

                    // CRITICAL: Validate each item - FIXED
                    const validItems = data.items.filter(item => {
                        // Item must be an object with required fields
                        return item &&
                               typeof item === 'object' &&
                               item.id != null &&
                               item.name &&
                               item.box != null;
                    });

                    const invalidCount = data.items.length - validItems.length;
                    if (invalidCount > 0) {
                        addLog('warning', `Filtered out ${invalidCount} invalid items (missing id, name, or box)`);
                    }

                    addLog('success', `âœ… Pull successful! Received ${validItems.length} valid items`);

                    // Show diff if requested
                    if (showDiff && items.length > 0) {
                        const diff = calculateSyncDiff(items, validItems);
                        if (diff.hasConflicts) {
                            dispatchSync({
                                type: 'SET_SYNC_DIFF',
                                payload: { show: true, data: diff }
                            });
                            setIsLoading(false);
                            return false; // Don't apply yet, let user review
                        }
                    }

                    setItems(validItems);
                    dispatchSync({ type: 'SET_CONNECTION_STATUS', payload: 'connected' });
                    dispatchSync({
                        type: 'SET_LAST_SYNC',
                        payload: { time: new Date().toLocaleString(), status: 'success' }
                    });

                    // Add to sync history
                    dispatchSync({
                        type: 'ADD_HISTORY',
                        payload: {
                            timestamp: new Date().toISOString(),
                            direction: 'pull',
                            status: 'success',
                            itemCount: validItems.length
                        }
                    });

                    return true;
                } catch (error) {
                    const errorInfo = detectErrorType(error, response);
                    addLog('error', errorInfo.title, errorInfo.message);

                    dispatchSync({ type: 'SET_CONNECTION_STATUS', payload: 'error' });
                    dispatchSync({
                        type: 'SET_LAST_SYNC',
                        payload: { time: new Date().toLocaleString(), status: 'failed' }
                    });

                    // Add to sync history
                    dispatchSync({
                        type: 'ADD_HISTORY',
                        payload: {
                            timestamp: new Date().toISOString(),
                            direction: 'pull',
                            status: 'failed',
                            error: errorInfo.message
                        }
                    });

                    showMessage(
                        `${errorInfo.title}\n${errorInfo.message}\n\nðŸ’¡ ${errorInfo.help}`,
                        'error'
                    );
                    return false;
                } finally {
                    setIsLoading(false);
                }
            };

            // Two-way sync with Google Sheets - ENHANCED with REQUEST DEDUPLICATION
            const syncWithSheets = async (direction = 'both') => {
                // CRITICAL: Prevent concurrent sync operations - FIXED
                if (syncInProgress.current) {
                    showMessage('âš ï¸ Sync already in progress. Please wait...', 'warning');
                    addLog('warning', 'Sync request ignored - operation already in progress');
                    return;
                }

                if (!settings.googleSheetsUrl) {
                    showMessage('Please configure Google Sheets URL in settings', 'error');
                    return;
                }

                syncInProgress.current = true;
                addLog('info', `Starting ${direction.toUpperCase()} sync...`);
                setIsLoading(true);

                try {
                    if (direction === 'push' || direction === 'both') {
                        const pushSuccess = await pushToSheets();
                        if (!pushSuccess) {
                            setIsLoading(false);
                            return; // Stop if push fails
                        }

                        if (direction === 'push') {
                            showMessage('âœ… Pushed to Google Sheets!');
                            setIsLoading(false);
                            return;
                        }

                        // For 'both' mode, add delay between push and pull to ensure data is saved
                        if (direction === 'both') {
                            addLog('info', 'Waiting 1 second before pulling to ensure data is saved...');
                            await new Promise(resolve => setTimeout(resolve, 1000));
                        }
                    }

                    if (direction === 'pull' || direction === 'both') {
                        const pullSuccess = await pullFromSheets();
                        if (pullSuccess) {
                            showMessage(direction === 'both' ? 'âœ… Two-way sync complete!' : 'âœ… Pulled from Google Sheets!');
                        }
                    }
                } catch (error) {
                    const errorInfo = detectErrorType(error, null);
                    addLog('error', `Sync failed: ${errorInfo.message}`);
                    showMessage(`Sync failed: ${error.message}`, 'error');
                } finally {
                    // CRITICAL: Always release lock - FIXED
                    setIsLoading(false);
                    syncInProgress.current = false;
                }
            };

            // Test Connection - NEW FEATURE
            const testConnection = async () => {
                const steps = [
                    { name: '1. Validating URL format', status: 'pending', icon: 'ðŸ”' },
                    { name: '2. Connecting to Google', status: 'pending', icon: 'ðŸŒ' },
                    { name: '3. Testing read access', status: 'pending', icon: 'ðŸ“–' },
                    { name: '4. Verifying response format', status: 'pending', icon: 'âœ“' }
                ];

                dispatchSync({ type: 'SET_TEST_RESULTS', payload: { steps, inProgress: true } });
                setIsLoading(true);
                addLog('info', 'ðŸ§ª Starting connection test...');

                try {
                    // Step 1: Validate URL
                    const urlCheck = validateGoogleSheetsUrl(settings.googleSheetsUrl);
                    if (!urlCheck.valid) {
                        steps[0].status = 'failed';
                        steps[0].error = urlCheck.error;
                        dispatchSync({ type: 'SET_TEST_RESULTS', payload: { steps, inProgress: false, overallStatus: 'failed' } });
                        addLog('error', 'URL validation failed', urlCheck.error);
                        setIsLoading(false);
                        return;
                    }
                    steps[0].status = 'success';
                    dispatchSync({ type: 'SET_TEST_RESULTS', payload: { steps, inProgress: true } });
                    await new Promise(resolve => setTimeout(resolve, 500)); // Visual delay

                    // Step 2: Test connection
                    addLog('info', 'Testing connection...');
                    const response = await fetchWithTimeout(settings.googleSheetsUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'getAll' })
                    }, 10000);

                    if (response.ok) {
                        steps[1].status = 'success';
                        dispatchSync({ type: 'SET_TEST_RESULTS', payload: { steps, inProgress: true } });
                    } else {
                        steps[1].status = 'failed';
                        steps[1].error = `HTTP ${response.status}`;
                        dispatchSync({ type: 'SET_TEST_RESULTS', payload: { steps, inProgress: false, overallStatus: 'failed' } });
                        addLog('error', `Connection failed: HTTP ${response.status}`);
                        setIsLoading(false);
                        return;
                    }
                    await new Promise(resolve => setTimeout(resolve, 500));

                    // Step 3: Test read
                    addLog('info', 'Testing read access...');
                    const data = await validateResponse(response);
                    if (data.success !== undefined || data.items !== undefined) {
                        steps[2].status = 'success';
                        dispatchSync({ type: 'SET_TEST_RESULTS', payload: { steps, inProgress: true } });
                    } else {
                        steps[2].status = 'failed';
                        steps[2].error = 'Unexpected response format';
                        dispatchSync({ type: 'SET_TEST_RESULTS', payload: { steps, inProgress: false, overallStatus: 'failed' } });
                        addLog('error', 'Read test failed: unexpected format');
                        setIsLoading(false);
                        return;
                    }
                    await new Promise(resolve => setTimeout(resolve, 500));

                    // Step 4: Verify format
                    if (data.items && Array.isArray(data.items)) {
                        steps[3].status = 'success';
                        steps[3].note = `Found ${data.items.length} items`;
                        dispatchSync({ type: 'SET_TEST_RESULTS', payload: { steps, inProgress: false, overallStatus: 'success' } });
                        addLog('success', 'âœ… All connection tests passed!');
                        dispatchSync({ type: 'SET_CONNECTION_STATUS', payload: 'connected' });
                        showMessage('âœ… Connection test passed! Your setup is working correctly.', 'success');
                    } else {
                        steps[3].status = 'success';
                        steps[3].note = 'Empty spreadsheet (this is OK)';
                        dispatchSync({ type: 'SET_TEST_RESULTS', payload: { steps, inProgress: false, overallStatus: 'success' } });
                        addLog('success', 'âœ… Connection test passed (empty sheet)');
                        dispatchSync({ type: 'SET_CONNECTION_STATUS', payload: 'connected' });
                        showMessage('âœ… Connection test passed!', 'success');
                    }

                } catch (error) {
                    const errorInfo = detectErrorType(error, null);
                    const failedStepIndex = steps.findIndex(s => s.status === 'pending');
                    if (failedStepIndex !== -1) {
                        steps[failedStepIndex].status = 'failed';
                        steps[failedStepIndex].error = errorInfo.message;
                    }
                    dispatchSync({ type: 'SET_TEST_RESULTS', payload: { steps, inProgress: false, overallStatus: 'failed', errorHelp: errorInfo.help } });
                    addLog('error', 'Connection test failed', errorInfo.message);
                    dispatchSync({ type: 'SET_CONNECTION_STATUS', payload: 'error' });
                    showMessage(`âŒ Connection test failed: ${errorInfo.message}`, 'error');
                } finally {
                    setIsLoading(false);
                }
            };

            // AI Voice Entry
            const startVoiceRecording = () => {
                if (!settings.aiEnabled) {
                    showMessage('Please enable AI features in settings', 'error');
                    return;
                }

                if ('webkitSpeechRecognition' in window) {
                    const recognition = new webkitSpeechRecognition();
                    recognition.continuous = false;
                    recognition.interimResults = false;

                    recognition.onstart = () => {
                        setIsRecording(true);
                        setTranscript('Listening...');
                    };

                    recognition.onresult = async (event) => {
                        const spokenText = event.results[0][0].transcript;
                        setTranscript(spokenText);
                        
                        // Process with AI
                        await processVoiceCommand(spokenText);
                    };

                    recognition.onerror = () => {
                        showMessage('Voice recognition error', 'error');
                        setIsRecording(false);
                    };

                    recognition.onend = () => {
                        setIsRecording(false);
                    };

                    recognition.start();
                } else {
                    showMessage('Voice recognition not supported', 'error');
                }
            };

            // Process voice command with AI
            const processVoiceCommand = async (text) => {
                setIsLoading(true);
                try {
                    const response = await fetch(`${settings.ollamaUrl}/api/generate`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model: 'llama3.1:8b',
                            prompt: `Extract tools and box number from: "${text}". Return ONLY JSON: {"box": "number", "items": ["item1", "item2"]}`,
                            stream: false
                        })
                    });

                    const data = await response.json();
                    const parsed = JSON.parse(data.response);
                    
                    // Add items
                    const newItems = parsed.items.map(itemName => ({
                        id: Date.now() + Math.random(),
                        name: itemName,
                        box: parsed.box,
                        quantity: '1',
                        notes: 'Added via voice'
                    }));
                    
                    setItems([...items, ...newItems]);
                    showMessage(`Added ${newItems.length} items to Box ${parsed.box}!`);
                    setView('search');
                } catch (error) {
                    showMessage('AI processing failed. Using manual entry.', 'error');
                    console.error(error);
                }
                setIsLoading(false);
            };

            // AI Photo Identification
            const startCamera = async () => {
                if (!settings.aiEnabled) {
                    showMessage('Please enable AI features in settings', 'error');
                    return;
                }

                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'environment' } 
                    });
                    if (videoRef.current) {
                        videoRef.current.srcObject = stream;
                    }
                } catch (error) {
                    showMessage('Camera access denied', 'error');
                }
            };

            const capturePhoto = async () => {
                if (canvasRef.current && videoRef.current) {
                    const canvas = canvasRef.current;
                    const video = videoRef.current;
                    
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    canvas.getContext('2d').drawImage(video, 0, 0);
                    
                    const imageData = canvas.toDataURL('image/jpeg');
                    setCapturedImage(imageData);
                    
                    // Stop camera
                    video.srcObject.getTracks().forEach(track => track.stop());
                    
                    // Send to AI server
                    await identifyWithAI(imageData);
                }
            };

            const identifyWithAI = async (imageData) => {
                setIsLoading(true);
                try {
                    const response = await fetch(`${settings.aiServerUrl}/identify`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ image: imageData })
                    });

                    const data = await response.json();
                    setAiIdentification(data);
                    showMessage('Tool identified by AI!');
                } catch (error) {
                    showMessage('AI identification failed. You can still add manually.', 'error');
                    console.error(error);
                }
                setIsLoading(false);
            };

            // Save settings
            const saveSettings = () => {
                Object.keys(settings).forEach(key => {
                    localStorage.setItem(key, settings[key]);
                });
                showMessage('Settings saved!');
            };

            // Get unique boxes
            const uniqueBoxes = [...new Set(items.map(item => item.box))].sort((a, b) => {
                const numA = parseInt(a);
                const numB = parseInt(b);
                return numA - numB;
            });

            // Render views
            const renderSearch = () => (
                <div className="p-4">
                    <div className="mb-4">
                        <div className="relative">
                            <input
                                type="text"
                                value={searchQuery}
                                onChange={(e) => setSearchQuery(e.target.value)}
                                placeholder="Search tools... (e.g., 'ha' for hammer)"
                                className="w-full px-4 py-3 pl-12 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                            />
                            <SearchIcon className="absolute left-4 top-3.5 text-gray-400" />
                        </div>
                    </div>

                    {searchQuery && filteredItems.length > 0 && (
                        <div className="space-y-2">
                            {filteredItems.map(item => (
                                <div key={item.id} className="bg-white border-2 rounded-lg p-4 shadow-sm">
                                    <div className="flex justify-between items-start mb-2">
                                        <div>
                                            <h3 className="font-bold text-lg">{item.name}</h3>
                                            <p className="text-sm text-gray-600">Box {item.box}</p>
                                        </div>
                                        <div className="flex gap-2">
                                            <button
                                                onClick={() => handleEditItem(item)}
                                                className="p-2 text-blue-600 hover:bg-blue-50 rounded"
                                            >
                                                <EditIcon />
                                            </button>
                                            <button
                                                onClick={() => handleDeleteItem(item.id)}
                                                className="p-2 text-red-600 hover:bg-red-50 rounded"
                                            >
                                                <TrashIcon />
                                            </button>
                                        </div>
                                    </div>
                                    <p className="text-sm text-gray-700">Quantity: {item.quantity}</p>
                                    {item.notes && (
                                        <p className="text-sm text-gray-600 mt-1">{item.notes}</p>
                                    )}
                                </div>
                            ))}
                        </div>
                    )}

                    {searchQuery && filteredItems.length === 0 && (
                        <div className="text-center py-8 text-gray-500">
                            No items found. Try a different search.
                        </div>
                    )}

                    {!searchQuery && (
                        <div className="text-center py-12">
                            <SearchIcon className="mx-auto mb-4 text-gray-400" style={{width: 48, height: 48}} />
                            <h3 className="text-xl font-semibold mb-2">Find Your Tools</h3>
                            <p className="text-gray-600">Start typing to search your inventory</p>
                        </div>
                    )}
                </div>
            );

            const renderAddEdit = () => (
                <div className="p-4">
                    <h2 className="text-2xl font-bold mb-4">
                        {editingItem ? 'Edit Item' : 'Add New Item'}
                    </h2>
                    
                    <div className="space-y-4">
                        <div>
                            <label className="block text-sm font-medium mb-1">Item Name *</label>
                            <input
                                type="text"
                                value={formData.name}
                                onChange={(e) => setFormData({...formData, name: e.target.value})}
                                placeholder="e.g., Hammer"
                                className="w-full px-4 py-2 border-2 rounded-lg focus:border-blue-500 focus:outline-none"
                            />
                        </div>

                        <div>
                            <label className="block text-sm font-medium mb-1">Box Number *</label>
                            <input
                                type="text"
                                value={formData.box}
                                onChange={(e) => setFormData({...formData, box: e.target.value})}
                                placeholder="e.g., 10"
                                className="w-full px-4 py-2 border-2 rounded-lg focus:border-blue-500 focus:outline-none"
                            />
                        </div>

                        <div>
                            <label className="block text-sm font-medium mb-1">Quantity</label>
                            <input
                                type="number"
                                value={formData.quantity}
                                onChange={(e) => setFormData({...formData, quantity: e.target.value})}
                                min="1"
                                className="w-full px-4 py-2 border-2 rounded-lg focus:border-blue-500 focus:outline-none"
                            />
                        </div>

                        <div>
                            <label className="block text-sm font-medium mb-1">Notes (Optional)</label>
                            <textarea
                                value={formData.notes}
                                onChange={(e) => setFormData({...formData, notes: e.target.value})}
                                placeholder="Any additional details..."
                                rows="3"
                                className="w-full px-4 py-2 border-2 rounded-lg focus:border-blue-500 focus:outline-none"
                            />
                        </div>

                        <div className="flex gap-2 pt-4">
                            <button
                                onClick={handleSaveItem}
                                className="flex-1 bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700"
                            >
                                {editingItem ? 'Update Item' : 'Add Item'}
                            </button>
                            <button
                                onClick={() => {
                                    setView('search');
                                    setEditingItem(null);
                                    setFormData({ name: '', box: '', quantity: '1', notes: '', photo: null });
                                }}
                                className="px-6 py-3 border-2 rounded-lg font-semibold hover:bg-gray-50"
                            >
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            );

            const renderBoxes = () => (
                <div className="p-4">
                    <h2 className="text-2xl font-bold mb-4">Browse by Box</h2>
                    
                    {uniqueBoxes.length === 0 ? (
                        <div className="text-center py-12 text-gray-500">
                            No boxes yet. Add items to get started!
                        </div>
                    ) : (
                        <div className="grid grid-cols-2 gap-3">
                            {uniqueBoxes.map(box => {
                                const boxItems = items.filter(item => item.box === box);
                                return (
                                    <div key={box} className="bg-white border-2 rounded-lg p-4 shadow-sm">
                                        <div className="flex items-center gap-2 mb-2">
                                            <BoxIcon />
                                            <h3 className="font-bold text-lg">Box {box}</h3>
                                        </div>
                                        <p className="text-sm text-gray-600">{boxItems.length} items</p>
                                        <div className="mt-2 space-y-1">
                                            {boxItems.slice(0, 3).map(item => (
                                                <p key={item.id} className="text-sm text-gray-700 truncate">
                                                    â€¢ {item.name}
                                                </p>
                                            ))}
                                            {boxItems.length > 3 && (
                                                <p className="text-sm text-gray-500">
                                                    +{boxItems.length - 3} more
                                                </p>
                                            )}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}
                </div>
            );

            const renderAIPhoto = () => (
                <div className="p-4">
                    <h2 className="text-2xl font-bold mb-4">AI Photo Identification</h2>
                    
                    {!capturedImage ? (
                        <div>
                            <video
                                ref={videoRef}
                                autoPlay
                                playsInline
                                className="w-full rounded-lg mb-4"
                            />
                            <canvas ref={canvasRef} className="hidden" />
                            
                            <div className="flex gap-2">
                                <button
                                    onClick={capturePhoto}
                                    className="flex-1 bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700"
                                >
                                    Capture Photo
                                </button>
                                <button
                                    onClick={() => {
                                        if (videoRef.current && videoRef.current.srcObject) {
                                            videoRef.current.srcObject.getTracks().forEach(track => track.stop());
                                        }
                                        setView('search');
                                    }}
                                    className="px-6 py-3 border-2 rounded-lg font-semibold hover:bg-gray-50"
                                >
                                    Cancel
                                </button>
                            </div>
                        </div>
                    ) : (
                        <div>
                            <img src={capturedImage} alt="Captured" className="w-full rounded-lg mb-4" />
                            
                            {aiIdentification && (
                                <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 mb-4">
                                    <h3 className="font-bold mb-2">AI Identified:</h3>
                                    <p className="text-lg">{aiIdentification.tool}</p>
                                    <p className="text-sm text-gray-600">
                                        Confidence: {Math.round(aiIdentification.confidence * 100)}%
                                    </p>
                                    {aiIdentification.suggestedBox && (
                                        <p className="text-sm text-gray-600">
                                            Suggested Box: {aiIdentification.suggestedBox}
                                        </p>
                                    )}
                                </div>
                            )}
                            
                            <div className="flex gap-2">
                                <button
                                    onClick={() => {
                                        if (aiIdentification) {
                                            setFormData({
                                                name: aiIdentification.tool,
                                                box: aiIdentification.suggestedBox || '',
                                                quantity: '1',
                                                notes: 'Identified by AI',
                                                photo: capturedImage
                                            });
                                            setView('add');
                                        }
                                        setCapturedImage(null);
                                        setAiIdentification(null);
                                    }}
                                    className="flex-1 bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700"
                                >
                                    Add to Inventory
                                </button>
                                <button
                                    onClick={() => {
                                        setCapturedImage(null);
                                        setAiIdentification(null);
                                        startCamera();
                                    }}
                                    className="px-6 py-3 border-2 rounded-lg font-semibold hover:bg-gray-50"
                                >
                                    Retake
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );

            const renderAIVoice = () => (
                <div className="p-4">
                    <h2 className="text-2xl font-bold mb-4">AI Voice Entry</h2>
                    
                    <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 mb-4">
                        <h3 className="font-semibold mb-2">How to use:</h3>
                        <p className="text-sm text-gray-700">
                            Say something like: "Box 10 has hammer, screwdriver, and drill"
                        </p>
                    </div>

                    <div className="text-center py-8">
                        {isRecording ? (
                            <div className="mb-4">
                                <div className="animate-pulse">
                                    <MicIcon className="mx-auto mb-2 text-red-500" style={{width: 64, height: 64}} />
                                </div>
                                <p className="text-lg font-semibold">Listening...</p>
                            </div>
                        ) : (
                            <button
                                onClick={startVoiceRecording}
                                className="bg-blue-600 text-white px-8 py-4 rounded-full font-semibold hover:bg-blue-700 inline-flex items-center gap-2"
                            >
                                <MicIcon />
                                Start Recording
                            </button>
                        )}
                    </div>

                    {transcript && (
                        <div className="bg-gray-50 border-2 rounded-lg p-4 mb-4">
                            <h3 className="font-semibold mb-2">You said:</h3>
                            <p className="text-gray-700">{transcript}</p>
                        </div>
                    )}

                    <button
                        onClick={() => setView('search')}
                        className="w-full py-3 border-2 rounded-lg font-semibold hover:bg-gray-50"
                    >
                        Back to Search
                    </button>
                </div>
            );

            const renderSettings = () => {
                const getConnectionStatusColor = () => {
                    switch(syncState.connectionStatus) {
                        case 'connected': return 'bg-green-500';
                        case 'error': return 'bg-red-500';
                        case 'disconnected': return 'bg-yellow-500';
                        default: return 'bg-gray-400';
                    }
                };

                const getConnectionStatusText = () => {
                    switch(syncState.connectionStatus) {
                        case 'connected': return 'âœ“ Connected';
                        case 'error': return 'âœ— Error';
                        case 'disconnected': return 'âš  Disconnected';
                        default: return '? Unknown';
                    }
                };

                return (
                    <div className="p-4 pb-24">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-2xl font-bold">Settings</h2>
                            <div className={`px-3 py-1 rounded-full text-white text-xs font-semibold ${getConnectionStatusColor()}`}>
                                {getConnectionStatusText()}
                            </div>
                        </div>

                        <div className="space-y-4">
                            {/* Setup Wizard */}
                            <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-4">
                                <h3 className="font-semibold mb-3 text-blue-900">ðŸ“‹ Setup Checklist</h3>
                                <div className="space-y-2 text-sm">
                                    <label className="flex items-start gap-2 cursor-pointer">
                                        <input
                                            type="checkbox"
                                            checked={setupProgress.step1}
                                            onChange={(e) => updateSetupProgress('step1', e.target.checked)}
                                            className="mt-1 w-4 h-4"
                                        />
                                        <span className={setupProgress.step1 ? 'line-through text-gray-500' : ''}>
                                            Created Google Sheet with columns: ID, Item Name, Box Number, Quantity, Notes
                                        </span>
                                    </label>
                                    <label className="flex items-start gap-2 cursor-pointer">
                                        <input
                                            type="checkbox"
                                            checked={setupProgress.step2}
                                            onChange={(e) => updateSetupProgress('step2', e.target.checked)}
                                            className="mt-1 w-4 h-4"
                                        />
                                        <span className={setupProgress.step2 ? 'line-through text-gray-500' : ''}>
                                            Opened Extensions â†’ Apps Script and pasted the code
                                        </span>
                                    </label>
                                    <label className="flex items-start gap-2 cursor-pointer">
                                        <input
                                            type="checkbox"
                                            checked={setupProgress.step3}
                                            onChange={(e) => updateSetupProgress('step3', e.target.checked)}
                                            className="mt-1 w-4 h-4"
                                        />
                                        <span className={setupProgress.step3 ? 'line-through text-gray-500' : ''}>
                                            Deployed as Web App: "Execute as: Me" and "Who has access: Anyone"
                                        </span>
                                    </label>
                                    <label className="flex items-start gap-2 cursor-pointer">
                                        <input
                                            type="checkbox"
                                            checked={setupProgress.step4}
                                            onChange={(e) => updateSetupProgress('step4', e.target.checked)}
                                            className="mt-1 w-4 h-4"
                                        />
                                        <span className={setupProgress.step4 ? 'line-through text-gray-500' : ''}>
                                            Copied the Web App URL (should end with /exec)
                                        </span>
                                    </label>
                                    <label className="flex items-start gap-2 cursor-pointer">
                                        <input
                                            type="checkbox"
                                            checked={setupProgress.step5}
                                            onChange={(e) => updateSetupProgress('step5', e.target.checked)}
                                            className="mt-1 w-4 h-4"
                                        />
                                        <span className={setupProgress.step5 ? 'line-through text-gray-500' : ''}>
                                            Pasted URL below and clicked "Test Connection"
                                        </span>
                                    </label>
                                </div>
                            </div>

                            {/* Google Sheets Integration */}
                            <div>
                                <h3 className="font-semibold mb-2">Google Sheets Integration</h3>
                                <input
                                    type="text"
                                    value={settings.googleSheetsUrl}
                                    onChange={(e) => setSettings({...settings, googleSheetsUrl: e.target.value})}
                                    placeholder="Paste your Google Apps Script Web App URL here"
                                    className="w-full px-4 py-2 border-2 rounded-lg focus:border-blue-500 focus:outline-none mb-2 text-sm"
                                />

                                {/* Test Connection Button */}
                                <button
                                    onClick={testConnection}
                                    disabled={!settings.googleSheetsUrl}
                                    className="w-full bg-purple-600 text-white py-2 rounded-lg text-sm font-semibold hover:bg-purple-700 disabled:bg-gray-300 mb-3"
                                >
                                    ðŸ§ª Test Connection
                                </button>

                                {/* Test Results */}
                                {syncState.testResults && (
                                    <div className={`border-2 rounded-lg p-3 mb-3 ${syncState.testResults.overallStatus === 'success' ? 'bg-green-50 border-green-300' : syncState.testResults.overallStatus === 'failed' ? 'bg-red-50 border-red-300' : 'bg-blue-50 border-blue-300'}`}>
                                        <h4 className="font-semibold text-sm mb-2">Connection Test Results:</h4>
                                        <div className="space-y-1">
                                            {syncState.testResults.steps.map((step, idx) => (
                                                <div key={idx} className="flex items-start gap-2 text-xs">
                                                    <span>
                                                        {step.status === 'success' ? 'âœ…' : step.status === 'failed' ? 'âŒ' : 'â³'}
                                                    </span>
                                                    <div className="flex-1">
                                                        <span className={step.status === 'failed' ? 'text-red-700 font-semibold' : ''}>{step.name}</span>
                                                        {step.error && <div className="text-red-600 mt-1">{step.error}</div>}
                                                        {step.note && <div className="text-gray-600 mt-1">{step.note}</div>}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                        {syncState.testResults.errorHelp && (
                                            <div className="mt-2 p-2 bg-white rounded text-xs whitespace-pre-line">
                                                <strong>ðŸ’¡ How to fix:</strong><br/>{syncState.testResults.errorHelp}
                                            </div>
                                        )}
                                    </div>
                                )}

                                {/* Last Sync Info */}
                                {syncState.lastSyncTime && (
                                    <div className="text-xs text-gray-600 mb-2">
                                        Last sync: {syncState.lastSyncTime} ({syncState.lastSyncStatus === 'success' ? 'âœ…' : 'âŒ'})
                                    </div>
                                )}

                                <label className="flex items-center gap-2 mb-3">
                                    <input
                                        type="checkbox"
                                        checked={settings.autoSync}
                                        onChange={(e) => setSettings({...settings, autoSync: e.target.checked})}
                                        className="w-4 h-4"
                                    />
                                    <span className="text-sm">Auto-sync changes to Google Sheets</span>
                                </label>

                                <div className="bg-gray-50 border-2 border-gray-200 rounded-lg p-3 mb-3">
                                    <p className="text-sm font-semibold mb-2">Sync Options:</p>
                                    <div className="space-y-1 text-xs text-gray-700">
                                        <div className="flex items-start gap-2">
                                            <span className="font-semibold text-blue-600 min-w-[45px]">PULL</span>
                                            <span>Download FROM Google Sheets (replaces local data)</span>
                                        </div>
                                        <div className="flex items-start gap-2">
                                            <span className="font-semibold text-orange-600 min-w-[45px]">PUSH</span>
                                            <span>Upload TO Google Sheets (replaces sheet data)</span>
                                        </div>
                                        <div className="flex items-start gap-2">
                                            <span className="font-semibold text-green-600 min-w-[45px]">BOTH</span>
                                            <span>Upload local, then download (two-way sync)</span>
                                        </div>
                                    </div>
                                </div>

                                <div className="grid grid-cols-3 gap-2 mb-3">
                                    <button
                                        onClick={() => syncWithSheets('pull')}
                                        disabled={!settings.googleSheetsUrl}
                                        className="bg-blue-600 text-white py-3 px-3 rounded-lg text-sm font-semibold hover:bg-blue-700 disabled:bg-gray-300"
                                    >
                                        â¬‡ï¸ Pull
                                    </button>
                                    <button
                                        onClick={() => syncWithSheets('push')}
                                        disabled={!settings.googleSheetsUrl}
                                        className="bg-orange-600 text-white py-3 px-3 rounded-lg text-sm font-semibold hover:bg-orange-700 disabled:bg-gray-300"
                                    >
                                        â¬†ï¸ Push
                                    </button>
                                    <button
                                        onClick={() => syncWithSheets('both')}
                                        disabled={!settings.googleSheetsUrl}
                                        className="bg-green-600 text-white py-3 px-3 rounded-lg text-sm font-semibold hover:bg-green-700 disabled:bg-gray-300"
                                    >
                                        â†•ï¸ Both
                                    </button>
                                </div>

                                {/* View Logs and History Buttons */}
                                <div className="grid grid-cols-2 gap-2">
                                    <button
                                        onClick={() => setShowLogs(true)}
                                        className="bg-gray-700 text-white py-2 px-3 rounded-lg text-xs font-semibold hover:bg-gray-800"
                                    >
                                        ðŸ“‹ View Logs ({syncLogs.length})
                                    </button>
                                    <button
                                        onClick={() => setView('syncHistory')}
                                        className="bg-gray-700 text-white py-2 px-3 rounded-lg text-xs font-semibold hover:bg-gray-800"
                                    >
                                        ðŸ“Š Sync History ({syncHistory.length})
                                    </button>
                                </div>
                            </div>

                            <div className="border-t-2 pt-4">
                                <h3 className="font-semibold mb-2">AI Features</h3>
                                <label className="flex items-center gap-2 mb-4">
                                    <input
                                        type="checkbox"
                                        checked={settings.aiEnabled}
                                        onChange={(e) => setSettings({...settings, aiEnabled: e.target.checked})}
                                        className="w-5 h-5"
                                    />
                                    <span>Enable AI Features (Photo ID & Voice)</span>
                                </label>

                                {settings.aiEnabled && (
                                    <>
                                        <div className="mb-3">
                                            <label className="block text-sm font-medium mb-1">Ollama URL</label>
                                            <input
                                                type="text"
                                                value={settings.ollamaUrl}
                                                onChange={(e) => setSettings({...settings, ollamaUrl: e.target.value})}
                                                placeholder="http://localhost:11434"
                                                className="w-full px-4 py-2 border-2 rounded-lg focus:border-blue-500 focus:outline-none"
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium mb-1">AI Server URL</label>
                                            <input
                                                type="text"
                                                value={settings.aiServerUrl}
                                                onChange={(e) => setSettings({...settings, aiServerUrl: e.target.value})}
                                                placeholder="http://localhost:8000"
                                                className="w-full px-4 py-2 border-2 rounded-lg focus:border-blue-500 focus:outline-none"
                                            />
                                        </div>
                                    </>
                                )}
                            </div>

                            <div className="pt-4">
                                <button
                                    onClick={saveSettings}
                                    className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700"
                                >
                                    ðŸ’¾ Save Settings
                                </button>
                            </div>

                            <div className="border-t-2 pt-4">
                                <h3 className="font-semibold mb-2">Data Management</h3>
                                <p className="text-sm text-gray-600 mb-2">
                                    {items.length} items in inventory
                                </p>
                                <button
                                    onClick={() => {
                                        const data = JSON.stringify(items, null, 2);
                                        const blob = new Blob([data], { type: 'application/json' });
                                        const url = URL.createObjectURL(blob);
                                        const a = document.createElement('a');
                                        a.href = url;
                                        a.download = 'inventory-backup.json';
                                        a.click();
                                        showMessage('Backup downloaded!');
                                    }}
                                    className="w-full bg-gray-600 text-white py-2 rounded-lg font-semibold hover:bg-gray-700"
                                >
                                    ðŸ’¾ Download Backup
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

            // Render Sync History View
            const renderSyncHistory = () => (
                <div className="p-4">
                    <h2 className="text-2xl font-bold mb-4">Sync History</h2>

                    {syncHistory.length === 0 ? (
                        <div className="text-center py-12 text-gray-500">
                            No sync history yet. Try syncing with Google Sheets!
                        </div>
                    ) : (
                        <div className="space-y-2">
                            {syncHistory.map((entry, idx) => (
                                <div key={idx} className={`border-2 rounded-lg p-3 ${entry.status === 'success' ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}`}>
                                    <div className="flex justify-between items-start mb-1">
                                        <div className="flex items-center gap-2">
                                            <span className="text-lg">
                                                {entry.direction === 'push' ? 'â¬†ï¸' : entry.direction === 'pull' ? 'â¬‡ï¸' : 'â†•ï¸'}
                                            </span>
                                            <span className="font-semibold capitalize">{entry.direction}</span>
                                        </div>
                                        <span className={`text-xs px-2 py-1 rounded ${entry.status === 'success' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'}`}>
                                            {entry.status === 'success' ? 'âœ“ Success' : 'âœ— Failed'}
                                        </span>
                                    </div>
                                    <div className="text-xs text-gray-600">
                                        {new Date(entry.timestamp).toLocaleString()}
                                    </div>
                                    {entry.itemCount !== undefined && (
                                        <div className="text-sm text-gray-700 mt-1">
                                            Items: {entry.itemCount}
                                        </div>
                                    )}
                                    {entry.error && (
                                        <div className="text-sm text-red-700 mt-1">
                                            Error: {entry.error}
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                    )}

                    <button
                        onClick={() => setView('settings')}
                        className="mt-4 w-full py-3 border-2 rounded-lg font-semibold hover:bg-gray-50"
                    >
                        â† Back to Settings
                    </button>
                </div>
            );

            // Logs Modal
            const renderLogsModal = () => {
                if (!showLogs) return null;

                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                        <div className="bg-white rounded-lg max-w-3xl w-full max-h-[80vh] overflow-hidden flex flex-col">
                            <div className="p-4 border-b-2 flex justify-between items-center">
                                <h2 className="text-xl font-bold">Sync Logs</h2>
                                <button
                                    onClick={() => setShowLogs(false)}
                                    className="p-2 hover:bg-gray-100 rounded"
                                >
                                    <XIcon />
                                </button>
                            </div>

                            <div className="flex-1 overflow-y-auto p-4">
                                {syncLogs.length === 0 ? (
                                    <div className="text-center py-12 text-gray-500">
                                        No logs yet. Logs will appear when you sync with Google Sheets.
                                    </div>
                                ) : (
                                    <div className="space-y-2 font-mono text-xs">
                                        {syncLogs.map((log, idx) => {
                                            const bgColor = log.level === 'error' ? 'bg-red-50' :
                                                          log.level === 'warning' ? 'bg-yellow-50' :
                                                          log.level === 'success' ? 'bg-green-50' :
                                                          'bg-gray-50';
                                            const icon = log.level === 'error' ? 'âŒ' :
                                                        log.level === 'warning' ? 'âš ï¸' :
                                                        log.level === 'success' ? 'âœ…' :
                                                        'â„¹ï¸';

                                            return (
                                                <div key={idx} className={`p-2 rounded ${bgColor} border`}>
                                                    <div className="flex items-start gap-2">
                                                        <span>{icon}</span>
                                                        <div className="flex-1">
                                                            <div className="text-gray-500">{new Date(log.timestamp).toLocaleTimeString()}</div>
                                                            <div className="font-semibold">{log.message}</div>
                                                            {log.details && (
                                                                <div className="text-gray-600 mt-1 whitespace-pre-wrap">
                                                                    {typeof log.details === 'string' ? log.details : JSON.stringify(log.details, null, 2)}
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}
                            </div>

                            <div className="p-4 border-t-2">
                                <button
                                    onClick={() => {
                                        const logsText = syncLogs.map(log =>
                                            `[${log.timestamp}] [${log.level.toUpperCase()}] ${log.message}${log.details ? '\n  ' + JSON.stringify(log.details) : ''}`
                                        ).join('\n\n');
                                        const blob = new Blob([logsText], { type: 'text/plain' });
                                        const url = URL.createObjectURL(blob);
                                        const a = document.createElement('a');
                                        a.href = url;
                                        a.download = 'sync-logs-' + new Date().toISOString().split('T')[0] + '.txt';
                                        a.click();
                                        showMessage('Logs downloaded!');
                                    }}
                                    className="w-full bg-gray-700 text-white py-2 rounded-lg font-semibold hover:bg-gray-800"
                                >
                                    ðŸ’¾ Download Logs
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

            // Sync Diff Modal
            const renderSyncDiffModal = () => {
                if (!showSyncDiff || !syncDiffData) return null;

                const { onlyLocal, onlyRemote, modified } = syncDiffData;

                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                        <div className="bg-white rounded-lg max-w-3xl w-full max-h-[80vh] overflow-hidden flex flex-col">
                            <div className="p-4 border-b-2">
                                <h2 className="text-xl font-bold mb-2">âš ï¸ Sync Conflicts Detected</h2>
                                <p className="text-sm text-gray-600">
                                    Your local inventory and Google Sheets have differences. Review before continuing.
                                </p>
                            </div>

                            <div className="flex-1 overflow-y-auto p-4 space-y-4">
                                {onlyLocal.length > 0 && (
                                    <div>
                                        <h3 className="font-semibold text-orange-700 mb-2">
                                            ðŸ“± Only in Local ({onlyLocal.length} items)
                                        </h3>
                                        <div className="space-y-1">
                                            {onlyLocal.slice(0, 5).map(item => (
                                                <div key={item.id} className="text-sm bg-orange-50 p-2 rounded">
                                                    {item.name} (Box {item.box})
                                                </div>
                                            ))}
                                            {onlyLocal.length > 5 && (
                                                <div className="text-xs text-gray-500">+ {onlyLocal.length - 5} more</div>
                                            )}
                                        </div>
                                    </div>
                                )}

                                {onlyRemote.length > 0 && (
                                    <div>
                                        <h3 className="font-semibold text-blue-700 mb-2">
                                            â˜ï¸ Only in Google Sheets ({onlyRemote.length} items)
                                        </h3>
                                        <div className="space-y-1">
                                            {onlyRemote.slice(0, 5).map(item => (
                                                <div key={item.id} className="text-sm bg-blue-50 p-2 rounded">
                                                    {item.name} (Box {item.box})
                                                </div>
                                            ))}
                                            {onlyRemote.length > 5 && (
                                                <div className="text-xs text-gray-500">+ {onlyRemote.length - 5} more</div>
                                            )}
                                        </div>
                                    </div>
                                )}

                                {modified.length > 0 && (
                                    <div>
                                        <h3 className="font-semibold text-purple-700 mb-2">
                                            ðŸ”„ Modified ({modified.length} items)
                                        </h3>
                                        <div className="space-y-2">
                                            {modified.slice(0, 3).map((diff, idx) => (
                                                <div key={idx} className="text-sm bg-purple-50 p-2 rounded">
                                                    <div className="font-semibold">{diff.local.name}</div>
                                                    <div className="text-xs text-gray-600">Local vs Remote differences detected</div>
                                                </div>
                                            ))}
                                            {modified.length > 3 && (
                                                <div className="text-xs text-gray-500">+ {modified.length - 3} more</div>
                                            )}
                                        </div>
                                    </div>
                                )}
                            </div>

                            <div className="p-4 border-t-2 space-y-2">
                                <div className="text-xs text-gray-600 mb-2">
                                    âš ï¸ Pulling will replace your local data with Google Sheets data. Make sure this is what you want!
                                </div>
                                <button
                                    onClick={async () => {
                                        setShowSyncDiff(false);
                                        setSyncDiffData(null);
                                        await pullFromSheets(false); // Pull without showing diff again
                                        showMessage('âœ… Pulled from Google Sheets!');
                                    }}
                                    className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700"
                                >
                                    â¬‡ï¸ Continue with Pull (Replace Local Data)
                                </button>
                                <button
                                    onClick={() => {
                                        setShowSyncDiff(false);
                                        setSyncDiffData(null);
                                    }}
                                    className="w-full border-2 py-3 rounded-lg font-semibold hover:bg-gray-50"
                                >
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

            const renderSetupGuide = () => (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-lg max-w-2xl w-full max-h-screen overflow-y-auto">
                        <div className="p-6">
                            <div className="flex justify-between items-start mb-4">
                                <h2 className="text-2xl font-bold">Welcome to AI Tool Inventory! ðŸ”§</h2>
                                <button
                                    onClick={() => setShowSetupGuide(false)}
                                    className="p-2 hover:bg-gray-100 rounded"
                                >
                                    <XIcon />
                                </button>
                            </div>

                            <div className="space-y-4">
                                <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-4">
                                    <h3 className="font-bold mb-2">âœ… Ready to Use Right Now!</h3>
                                    <p className="text-sm">
                                        Your app works immediately with sample data. Try searching and adding items!
                                    </p>
                                </div>

                                <div className="border-2 rounded-lg p-4">
                                    <h3 className="font-bold mb-2">ðŸ”— Optional: Connect Google Sheets</h3>
                                    <ol className="text-sm space-y-2 list-decimal list-inside">
                                        <li>Create a Google Sheet with columns: Item Name, Box Number, Quantity, Notes</li>
                                        <li>Go to Extensions â†’ Apps Script</li>
                                        <li>Paste the Apps Script code (see documentation)</li>
                                        <li>Deploy as Web App</li>
                                        <li>Copy the URL to Settings â†’ Google Sheets URL</li>
                                    </ol>
                                </div>

                                <div className="border-2 rounded-lg p-4">
                                    <h3 className="font-bold mb-2">ðŸ¤– Optional: Enable AI Features</h3>
                                    <p className="text-sm mb-2">
                                        Requires setup on your computer with RTX 3090:
                                    </p>
                                    <ul className="text-sm space-y-1 list-disc list-inside">
                                        <li>Install Ollama and download llama3.1:8b model</li>
                                        <li>Run the AI photo identification server</li>
                                        <li>Enable AI in Settings</li>
                                    </ul>
                                    <p className="text-sm text-gray-600 mt-2">
                                        See full documentation for detailed setup instructions.
                                    </p>
                                </div>

                                <button
                                    onClick={() => setShowSetupGuide(false)}
                                    className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700"
                                >
                                    Got It! Let's Start
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );

            // Check browser compatibility on load - FIXED
            useEffect(() => {
                const compatibility = checkBrowserCompatibility();
                if (!compatibility.compatible) {
                    // Only console log, don't update state in mount effect
                    console.error('Browser compatibility issues:', compatibility.issues);
                    showMessage(
                        `âš ï¸ Browser Compatibility Issues:\n${compatibility.issues.join(', ')}\n\nPlease use a modern browser like Chrome, Firefox, or Edge.`,
                        'error'
                    );
                }
            }, []); // Empty deps is safe now - no state updates

            // CRITICAL: Cleanup AbortControllers on unmount - FIXED
            useEffect(() => {
                // Return cleanup function
                return () => {
                    // Abort all in-flight requests when component unmounts
                    abortControllers.current.forEach(controller => {
                        try {
                            controller.abort();
                        } catch (e) {
                            // Ignore errors during cleanup
                        }
                    });
                    abortControllers.current.clear();
                };
            }, []);

            // Start camera when view changes to aiPhoto
            useEffect(() => {
                if (view === 'aiPhoto') {
                    startCamera();
                }
            }, [view]);

            return (
                <div className="min-h-screen bg-gray-50">
                    {/* Header */}
                    <header className="bg-blue-600 text-white p-4 shadow-lg">
                        <h1 className="text-xl font-bold">ðŸ”§ AI Tool Inventory</h1>
                    </header>

                    {/* Message Toast */}
                    {message.text && (
                        <div className={`fixed top-20 left-1/2 transform -translate-x-1/2 z-50 px-6 py-3 rounded-lg shadow-lg flex items-center gap-2 ${
                            message.type === 'success' ? 'bg-green-600' : 'bg-red-600'
                        } text-white`}>
                            {message.type === 'success' ? <CheckIcon /> : <AlertIcon />}
                            {message.text}
                        </div>
                    )}

                    {/* Loading Overlay */}
                    {isLoading && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white rounded-lg p-6 text-center">
                                <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                                <p className="font-semibold">Processing...</p>
                            </div>
                        </div>
                    )}

                    {/* Main Content */}
                    <main className="pb-20">
                        {view === 'search' && renderSearch()}
                        {view === 'add' && renderAddEdit()}
                        {view === 'boxes' && renderBoxes()}
                        {view === 'aiPhoto' && renderAIPhoto()}
                        {view === 'aiVoice' && renderAIVoice()}
                        {view === 'settings' && renderSettings()}
                        {view === 'syncHistory' && renderSyncHistory()}
                    </main>

                    {/* Modals */}
                    {renderLogsModal()}
                    {renderSyncDiffModal()}

                    {/* Bottom Navigation */}
                    <nav className="fixed bottom-0 left-0 right-0 bg-white border-t-2 shadow-lg">
                        <div className="flex justify-around py-2">
                            <button
                                onClick={() => setView('search')}
                                className={`flex flex-col items-center p-2 ${view === 'search' ? 'text-blue-600' : 'text-gray-600'}`}
                            >
                                <SearchIcon />
                                <span className="text-xs mt-1">Search</span>
                            </button>

                            <button
                                onClick={() => {
                                    setEditingItem(null);
                                    setFormData({ name: '', box: '', quantity: '1', notes: '', photo: null });
                                    setView('add');
                                }}
                                className={`flex flex-col items-center p-2 ${view === 'add' ? 'text-blue-600' : 'text-gray-600'}`}
                            >
                                <PlusIcon />
                                <span className="text-xs mt-1">Add</span>
                            </button>

                            <button
                                onClick={() => setView('boxes')}
                                className={`flex flex-col items-center p-2 ${view === 'boxes' ? 'text-blue-600' : 'text-gray-600'}`}
                            >
                                <BoxIcon />
                                <span className="text-xs mt-1">Boxes</span>
                            </button>

                            {settings.aiEnabled && (
                                <>
                                    <button
                                        onClick={() => setView('aiPhoto')}
                                        className={`flex flex-col items-center p-2 ${view === 'aiPhoto' ? 'text-blue-600' : 'text-gray-600'}`}
                                    >
                                        <CameraIcon />
                                        <span className="text-xs mt-1">AI Photo</span>
                                    </button>

                                    <button
                                        onClick={() => setView('aiVoice')}
                                        className={`flex flex-col items-center p-2 ${view === 'aiVoice' ? 'text-blue-600' : 'text-gray-600'}`}
                                    >
                                        <MicIcon />
                                        <span className="text-xs mt-1">AI Voice</span>
                                    </button>
                                </>
                            )}

                            <button
                                onClick={() => setView('settings')}
                                className={`flex flex-col items-center p-2 ${view === 'settings' ? 'text-blue-600' : 'text-gray-600'}`}
                            >
                                <SettingsIcon />
                                <span className="text-xs mt-1">Settings</span>
                            </button>
                        </div>
                    </nav>

                    {/* Setup Guide Modal */}
                    {showSetupGuide && renderSetupGuide()}
                </div>
            );
        }

        ReactDOM.render(<InventoryApp />, document.getElementById('root'));
    </script>
</body>
</html>